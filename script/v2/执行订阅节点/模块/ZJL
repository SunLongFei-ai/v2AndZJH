#****************************************************
# Author: ZJL
# QQ: 1965786708
# Version: 2.0 beta31.5
# Date: 2021-8-13 20:30
# FileName: ZJL
# Description: æ•´åˆtinyã€clncçš„å…æµé˜²è·³
#****************************************************

# é˜²è·³ç‰ˆæœ¬
readonly zjl_version="2.0 beta31.5"
readonly zjl_update_date="2021-8-13 20:30"

# æ˜¾ç¤ºå¸®åŠ© []<-(errorMsg:String)
show_help() {
    # è¾“å‡ºé”™è¯¯æ¶ˆæ¯
    [[ ${1} ]] && echo "\nERROR: ${1}\n"
  
    echo "\n  *******************************"
    
    echo " â•­ â•¯â•­ â•¯â•­ â•¯"

echo " â•­â•©â•â•®.â•”â•â•â•â•â•—â•”â•â•â•â•â•—â•”â•â•â•"
echo "â•­â•¯å˜Ÿå˜Ÿ  ~~ââââ â• â•£~~ââââ• â•£âââ â• "
echo "â•°âŠ™â•âŠ™â•¯â•šâŠ™â•âŠ™â•â•šâŠ™â•âŠ™â•â•šâŠ™â•âŠ™â• â•š\n"
 echo 
    echo "  *******************************\n"
    echo "  V2 ZJL é˜²è·³ ${zjl_version}ï¼Œå…æµğŸ‘"
    echo "  æ›´æ–°æ—¶é—´ ${zjl_update_date}"
    echo "  æ›´æ–°åœ°å€: https://yaohuo.me"
    echo "  å¤©é’è‰²ç­‰çƒŸé›¨ï¼Œè€Œæˆ‘åœ¨ç­‰ä½ \n"
    
    echo "  Usage: ZJL [-o/-c]"
    echo "     or: ZJL [-o/-c] [-d]"
    echo "     or: ZJL [-o/-c] [-d] [-i]"
    echo "     or: ZJL [-d]"
    echo "     or: ZJL [-d] [-i]"
    echo "     or: ZJL [-h]"
    echo "     or: ZJL [-v]\n"
    
    echo "  -o or --open         å¼€å¯é˜²è·³"
    echo "  -c or --close        å…³é—­é˜²è·³"
    echo "  -d or --display      æ˜¾ç¤ºç•Œé¢"
    echo "  -i or --info         æ˜¾ç¤ºæ‰€æœ‰è¾“å‡º"
    echo "  -h or --help         æŸ¥çœ‹å¸®åŠ©"
    echo "  -v or --version      æŸ¥çœ‹ç‰ˆæœ¬\n"
    
    echo "  æœ€å¤šæ”¯æŒä¸‰ä¸ªæœ‰æ•ˆé€‰é¡¹:"
    echo "  -o å’Œ -c äºŒé€‰ä¸€ ä¸å¯åŒæ—¶é€‰æ‹©"
    echo "  -h å’Œ -v å•ç‹¬ä½¿ç”¨ ä¾‹: ZJL -h"
echo " ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"
curl https://myip.ipip.net/      
echo " ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"
    
    # é€€å‡ºè„šæœ¬
    exit
}


# è§£æjson è·å– key å¯¹åº”çš„ value(æ­¤å‡½æ•°ä¸é€‚äºæœ‰å¤šä¸ª key ä¸€æ ·çš„) [String]<-(json:String, key:String)
get_json_value(){
    echo "`echo "${1}" | sed "s/\\"//g;s/.*${2}[ \t]*:[ \t]*\([^,}]*\).*/\1/"`"
}


# è¯»å–é…ç½®é‡Œ = å·åé¢çš„å†…å®¹ [String]<-(arg:String)
get_configure() {
    echo "`echo "${configure_file_content}" | grep "^ *${1}=" | sed "s/^ *${1}=//"`"
}


# è·å–æ¨¡å¼æŒ‡å®šçš„çš„ç«¯å£ [int]<-(arg:String)
get_confPort() {
    echo "`echo "${mode_listen_port_list}" | grep "^ *${1}" | sed "s/.*://" | grep -o "[0-9][0-9]*"`"
}


# é€šè¿‡åŒ…åè¯»å–åº”ç”¨UID [int]<-(packageName:String, is_port:String)
package_to_uid() {
    local port
    local uids
    
    for ZJL in ${1}; do
        port=""
        if [[ "port" == ${2} ]]; then
            port="_${ZJL#*_}"
            ZJL="${ZJL%%_*}"
        fi
        
        if [[ "port" != ${2} || "ZJL" != ${ZJL} ]] && [[ `echo "${ZJL}" | grep -E "^([a-zA-Z_][a-zA-Z0-9_]*[.])*([a-zA-Z_][a-zA-Z0-9_]*)$"` ]]; then
            ZJL="`echo "${package_uid_list}" | grep -i "${ZJL} " | sed 's/.*[ \t]//'`"
        fi
        
        uids="${uids} ${ZJL}${port}"
    done
    
    echo "${uids}"
}


# è¯»å–æ¨¡å¼åŠç«¯å£ []<-() 
read_mode_port() {
    [[ ${core_mode_path} ]] && mode="${core_mode_path}"
    
    # è¯»å–æ¨¡å¼å†…å®¹ å»é™¤äº†ç©ºè¡Œä»¥åŠ//å’Œ#å¼€å¤´çš„å†…å®¹
    mode_file_content="`grep -Ev '^ *$|^# *|^ *//' ${mode}`"
    
    # è¯»å–æ¨¡å¼å†…å¸¦æœ‰ç«¯å£å†…å®¹çš„è¡Œ
    mode_listen_port_list="`echo "${mode_file_content}" | grep "listen"`"
    
    # åˆ¤æ–­æ˜¯å¦æœ‰è¿è¡Œä¸­çš„æ ¸å¿ƒ
    if [[ ${core_name} ]]; then
        [[ ${core_name} == *tiny* ]] && unlimited_data_way='tiny' || unlimited_data_way='clnc'
    # åˆ¤æ–­æ˜¯å¦è‡ªåŠ¨è¯†åˆ«å…æµæ–¹å¼
    elif [[ ! ${unlimited_data_way} ]]; then
        [[ `echo "${mode_file_content}" | grep -E '(^ *user=)|(^ *uid=)'` ]] && unlimited_data_way='tiny' || unlimited_data_way='clnc'
    fi
    
    # åˆ¤æ–­æ ¸å¿ƒæ˜¯å¦ä¸ºclnc æ¨¡å¼æ˜¯å¦å¼€å¯UDP
    if [[ "tiny" != ${unlimited_data_way} && `echo "${mode_file_content}" | grep -i "httpUDP"` ]]; then
        # è¯»å–UDPè½¬å‘ç«¯å£
        udp_forward_port="`get_confPort udp_tproxy_listen`"
        
        # åˆ¤æ–­æ˜¯å¦å¼€å¯ä»£ç† UDP
        if [[ ${udp_forward_port} ]]; then
            if [[ `grep -i '^TPROXY$' /proc/net/ip_tables_targets` ]]; then
                [[ "ä»£ç†" == ${native_udp} && "æ”¾è¡Œ" != ${release_native_uid} && "ç¦ç½‘" != ${ban_native_uid} ]] && proxy_native_udp="true"
                [[ "ä»£ç†" == ${hotspot_udp}  && "æ”¾è¡Œ" != ${hotspot_network} && "ç¦ç½‘" != ${hotspot_network} ]] && proxy_hotspot_udp="true"
            else
                is_udp_supported="false"
            fi
        fi
    fi
}


# å¼€å…³æ•°æ®æµé‡ []<-(arg:String)
network_on_off() {
    # å¦‚æœæ²¡å¼€å¯[å¼€å…³æ•°æ®]åŠŸèƒ½ å°±ç›´æ¥é€€å‡ºå‡½æ•°
    [[ ! ${on_off_network} ]] && return 1
    
    [[ "open" == ${1} ]] && `svc data enable` || `svc data disable`
}


# æ”¾è¡Œæœ¬æœºUIDå¯¹åº”çš„åº”ç”¨ []<-(uid:String)
release_uid() {
    iptables -t nat -I OUTPUT -m owner --uid ${1} -j ACCEPT
    iptables -t mangle -I OUTPUT -m owner --uid ${1} -j ACCEPT
}


# æ”¾è¡Œæœ¬æœºæŒ‡å®šåè®®çš„UIDçš„ç«¯å£ []<-(protocol:String, uid_ports:String)
release_uid_ports() {
    [[ ${2} ]] || return 0
    
    local uid_ports="`package_to_uid "${2}" "port" | sed 's/[ ][ ]*/\n/g' | grep -Ei '^(([0-9]{1,9}|ZJL)(_(([1-9]|[1-9][0-9]{1,3}|[1-5][0-9]{4}|6[0-5][0-5][0-3][0-5])((,|:)([1-9]|[1-9][0-9]{1,3}|[1-5][0-9]{4}|6[0-5][0-5][0-3][0-5]))*)))$'`"
    local uid
    local ports
    local uid_content

    for ZJL in ${uid_ports}; do
        if [[ `echo "${ZJL}" | grep '_'` ]]; then
            uid=${ZJL%_*}
            ports=${ZJL#*_}
            
            uid_content=""
            [[ `echo "${uid}" | grep -i '^ZJL$'` ]] || uid_content="-m owner --uid ${uid}"
            
            # åˆ¤æ–­æ‰‹æœºæ˜¯å¦æ”¯æŒ multiport æ¨¡å—
            if [[ ${is_multiport_support} ]]; then
                iptables -t nat -I OUTPUT -p ${1} ${uid_content} -m multiport --dport ${ports} -j ACCEPT
                iptables -t mangle -I OUTPUT -p ${1} ${uid_content} -m multiport --dport ${ports} -j ACCEPT
            else
                for ZJL in `echo "${ports}" | sed 's/ /\n/g' | grep -v ':'`; do
                    iptables -t nat -I OUTPUT -p ${1} ${uid_content} --dport ${ZJL} -j ACCEPT
                    iptables -t mangle -I OUTPUT -p ${1} ${uid_content} --dport ${ZJL} -j ACCEPT
                done
            fi
        else
            uid_content=""
            [[ `echo "${ZJL}" | grep -i '^ZJL$'` ]] || uid_content="-m owner --uid ${ZJL}"
            
            iptables -t nat -I OUTPUT -p ${1} ${uid_content} -j ACCEPT
            iptables -t mangle -I OUTPUT -p ${1} ${uid_content} -j ACCEPT
        fi
    done
}


# æ”¾è¡Œå…±äº«æŒ‡å®šåè®®çš„ç«¯å£ []<-(chain:String, protocol:String, port:int)
release_hotspot_ports() {
    [[ ! ${2} ]] && return 0
    local ports="${2}"
    
    if [[ ${is_multiport_support} ]]; then
        ports="${ports// /,}"
        
        iptables -t mangle -I FORWARD -p ${1} -m multiport --dport ${ports} -j ACCEPT
        iptables -t nat -I PREROUTING -s 192.168/16 -p ${1} -m multiport --dport ${ports} -j ACCEPT
        iptables -t mangle -I PREROUTING -s 192.168/16 -p ${1} -m multiport --dport ${ports} -j ACCEPT
    else
        for ZJL in `echo "${ports}" | sed 's/ /\n/g' | grep -v ':'`; do
            iptables -t mangle -I FORWARD -p ${1} --dport ${ZJL} -j ACCEPT
            iptables -t nat -I PREROUTING -s 192.168/16 -p ${1} --dport ${ZJL} -j ACCEPT
            iptables -t mangle -I PREROUTING -s 192.168/16 -p ${1} --dport ${ZJL} -j ACCEPT
        done
    fi
}


# å†™å…¥å¼€æœºè‡ªå¯æ–‡ä»¶å†…å®¹ []<-()
boot_auto_on_file() {
    if [[ "delete" == ${2} ]]; then
        `rm -f ${1}`
        return
    fi
    
    echo "while true; do\n"\
          '    if [[ ! ${net_card} ]]; then'"\n"\
          '        net_card=`dumpsys connectivity | grep "NetworkAgentInfo{" | grep "type: MOBILE" | grep -iv "extra: ims" | grep -o "InterfaceName: [^ ]*" | grep -o "[^: ]*$"`'"\n"\
          '        net_card=${net_card:-`dumpsys netstats | grep -i "iface=" | grep "metered=true" | grep -Eio -m 1 "rmnet[^ ]*|ccmni[^ ]*"`}'"\n"\
          '        net_card=${net_card:-`ip route | grep -Eio -m 1 "rmnet[^ ]*|ccmni[^ ]*"`}'"\n"\
          '        net_card=${net_card:-`ifconfig | grep -Ei -A 1 "rmnet[^ ]*|ccmni[^ ]*" | grep -w -B 1 "inet" | grep -Eo "rmnet[^ ]*|ccmni[^ ]*"`}'"\n"\
          "    fi\n"\
          '    [[ ${net_card} && `ifconfig | grep -w -A 1 "${net_card}" | grep -o "inet addr:[^ ]*" | grep -o "[^: ]*$"` ]] && break || sleep 3'"\n"\
          "done\n"\
          "/system/bin/sh ${0} -o" > ${1}
    
    `chmod 777 ${path}`
}


# å¼€æœºè‡ªå¯ []<-()
boot_auto_on() {
    # è¯»å–é…ç½®æ–‡ä»¶å†…å¼€å¯è‡ªå¯å¡«çš„é€‰é¡¹
    local option="`get_configure å¼€æœºè‡ªå¯ | grep -Ei '^é€šç”¨|su|é¢å…·$'`"
    [[ `echo "${option}" | grep -i "^su$"` ]] && option="su"
    
    # è®¾ç½®é€šç”¨è‡ªå¯æ–‡ä»¶çš„è·¯å¾„
    local path="/system/bin/debuggerd"
    local read_state
    # è¯»å–è‡ªå¯æ–‡ä»¶æ˜¯å¦æœ‰æœ¬æ ¸å¿ƒçš„å¼€å¯å‘½ä»¤
    if [ -f ${path} ]; then
        [ -f /data/ZJL.sh ] && read_state="`cat /data/ZJL.sh | grep -w "${0}"`"
    fi
    
    # é€‰é¡¹ä¸º é€šç”¨ å°±ä¸ºtrue
    if [[ "é€šç”¨" == ${option} ]]; then
        # åˆ¤æ–­è‡ªå¯å‘½ä»¤æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œ
        if [ -f ${path}.ori ]; then
             [[ ${read_state} ]] || boot_auto_on_file "/data/ZJL.sh"
        else
            # æŠŠ debuggerd é‡å‘½åä¸º debuggerd.ori
            `mv -f ${path} ${path}.ori`
            # å†™å…¥å†…å®¹åˆ° debuggerd æ–‡ä»¶
            echo "#!/system/bin/sh\n/data/ZJL.sh &\n${path}.ori" >${path}
            # å†™å…¥é˜²è·³è·¯å¾„åˆ°çŠ¶æ€æ–‡ä»¶å†…
            boot_auto_on_file "/data/ZJL.sh"
            # ç»™è¦ç”¨åˆ°çš„æ–‡ä»¶èµ‹ä¸Š777æƒé™
            `chmod 777 ${path} ${path}.ori`
        fi
        
    # é€‰é¡¹ä¸ä¸º é€šç”¨ ä¸”çŠ¶æ€æ–‡ä»¶å­˜åœ¨çš„è¯ï¼Œå°±ä¸ºtrue
    elif [[ "é€šç”¨" != ${option} ]] && [ -f ${path}.ori ]; then
        # æŠŠ debuggerd.ori é‡å‘½åä¸º debuggerd
        `mv -f ${path}.ori ${path}`
        # ç»™ debuggerd æ–‡ä»¶èµ‹æƒé™
        `chmod 755 ${path}`
        # åˆ é™¤çŠ¶æ€æ–‡ä»¶
        boot_auto_on_file "/data/ZJL.sh"  "delete"
    fi
    
    
    # é‡å†™è·¯å¾„ï¼ŒSuperSUè‡ªå¯æ–¹æ³•
    local path="/su/su.d/ZJL.sh"
    [ -f ${path} ] && read_state="`cat ${path} | grep -w "${0}"`" || read_state=""
    
    # é€‰é¡¹ä¸ä¸º su ä¸”è‡ªå¯æ–‡ä»¶ä¸å­˜åœ¨çš„è¯ï¼Œå°±ä¸ºtrue
    if [[ "su" == ${option} && ! ${read_state} ]]; then
        # å†™å…¥é˜²è·³è·¯å¾„åˆ°è‡ªå¯æ–‡ä»¶
        boot_auto_on_file "${path}"
        
    # é€‰é¡¹ä¸ä¸º su ä¸”è‡ªå¯æ–‡ä»¶å­˜åœ¨çš„è¯ï¼Œå°±ä¸ºtrue
    elif [[ "su" == ${option} ]] && [ -f ${path} ]; then
        # åˆ é™¤è‡ªå¯æ–‡ä»¶
        boot_auto_on_file "${path}" "delete"
    fi
    
    
    # é‡å†™è·¯å¾„ï¼Œé¢å…·è‡ªå¯æ–¹æ³•
    if [ -d /sbin/.core/img/.core/service.d/ ]; then
        path=/sbin/.core/img/.core/service.d/ZJL.sh
    else
        path=/data/adb/service.d/ZJL.sh
    fi
    [ -f ${path} ] && read_state="`cat ${path} | grep -w "${0}"`" || read_state=""
    
    # é€‰é¡¹ä¸º é¢å…· ä¸”è‡ªå¯æ–‡ä»¶ä¸å­˜åœ¨çš„è¯ï¼Œå°±ä¸ºtrue
    if [[ "é¢å…·" == ${option} && ! ${read_state} ]]; then
        # å†™å…¥é˜²è·³è·¯å¾„åˆ°è‡ªå¯æ–‡ä»¶
        boot_auto_on_file "${path}"
        
    # é€‰é¡¹ä¸ä¸º é¢å…· ä¸”æ–‡ä»¶å­˜åœ¨çš„è¯ï¼Œå°±ä¸ºtrue
    elif [[ "é¢å…·" != ${option} ]] && [ -f ${path} ]; then
        # åˆ é™¤è‡ªå¯æ–‡ä»¶
        boot_auto_on_file "${path}" "delete"
    fi
}


# è·å–ä¼ å…¥çš„ç½‘å¡æ‰€ä½¿ç”¨çš„æµé‡ []<-(net_card:String)
get_net_card_traffic() {
    # åˆ¤æ–­æ˜¯å¦å­˜åœ¨busybox
    if [[ ${is_busybox_exist} ]]; then
        # è·å–ç½‘å¡ä½¿ç”¨çš„æµé‡
        local flow="`ifconfig ${1} | grep -i 'RX bytes' | sed 's/.*RX bytes:.*(\(.*B\)).*TX.*/\1/;s/i.*//'`"
        
        # è¾“å‡ºæµé‡æ•°
        [[ "0.0 B" == ${flow} || ! ${flow} ]] && center_output "å·²ç”¨: æ²¡æŸ¥åˆ° Ã—" "above" || center_output "å·²ç”¨: ${flow}  " "above"
    fi
}


# è·å–æŒ‡å®šå¾ªç¯æ¬¡æ•°çš„ç©ºæ ¼ []<-(number:Integer)
become_middle() {
    local product
    local product_head
    local min="1"
    local max="${1}"
    
    if [ ${max} -lt 7 ]; then
        max=$((max - 7))
        product_head="       "
    fi
    
    while [ ${min} -le ${max} ]; do
        product="${product} "
        ((min++))
    done
    
    echo "${product_head}${product}"
}


# è¾“å‡ºå±…ä¸­å‡½æ•° [String]<-(text:String, mode:String)
center_output() {
    local term_width="40"
    
    if [[ ${1} != ${dividing_line} ]]
    then
        local chinese="`echo "${1}" | grep -Eo '[^\x00-\xFF]+' | sed 's/[[:punct:]]//g;s/ //g'`"
        
        if [[ ${chinese} ]]; then
            local chinese_length="${#chinese}"
            local english_length="$((${#1} - chinese_length))"
            chinese_length=$((${chinese_length} * 40 / 77))
            local total_width="$((chinese_length + english_length))"
        else
            local total_width="${#1}"
        fi
        #è®¡ç®—æ¬¡æ•°
        local head_width="$(((term_width - total_width) / 2))"
        
        # è·å–å‰é¢è¦å¡«å……çš„ç©ºæ ¼
        local head="`become_middle "${head_width}"`"
    else
        # è·å–å‰é¢è¦å¡«å……çš„ç©ºæ ¼
        local head="       "
    fi
    
    # è¾“å‡ºå¤„ç†å¥½çš„å­—ç¬¦ä¸²
    case ${2} in
        above)
            echo "\n${head}${1}  "
        ;;
        not_exist)
            echo "${head}${1}  "
        ;;
        below|*)
            echo "${head}${1}\n"
        ;;
    esac
}


# è¾“å‡ºåˆ†å‰²çº¿ []<-(mode:String)
output_dividing_line() {
    center_output "${dividing_line}" "${1}"
}


# æ£€æµ‹æ ¸å¿ƒçŠ¶æ€ []<-()
read_core_state() {
    # è·å–æ ¸å¿ƒpid
    core_pid="`pgrep ^tiny`"
    core_pid="${core_pid:-"`pgrep ^clnc`"}"
    
    # æ£€æµ‹å½“å‰ä½¿ç”¨çš„å…æµæ ¸å¿ƒçŠ¶æ€
    if [[ ${core_pid} ]]; then
        core_name="`grep -a '.*' /proc/${core_pid}/comm`"
        
        local core_info="`grep -a '.*' /proc/${core_pid}/cmdline`"
        if [[ "1" == `echo "${core_info}" | grep -c '.*'` ]]; then
            core_mode_path="`echo "${core_info}" | grep -o '\-c.*conf' | sed -r 's/\-c(.*conf)/\1/'`"
        else
            core_mode_path="`echo "${core_info}" | grep -A 1 '\-c' | grep -v '^-c$'`"
        fi
        
        core_mode_name="${core_mode_path##*/}"
    fi
}


# æ ¸å¿ƒéƒ¨åˆ†çš„iptablesè§„åˆ™ []<-()
important_rules() {
    # è¯»å–çš„æ¨¡å¼ TCP å’Œ DNS çš„è½¬å‘ç«¯å£
    if [[ "clnc" == ${unlimited_data_way} ]]; then
        tcp_forward_port="`get_confPort tcp_listen`"
        dns_forward_port="`get_confPort dns_listen`"
    else
        tcp_forward_port="`get_confPort listen_port`"
        dns_forward_port="`get_confPort dns_listen_port`"
    fi
    
    
    # ----- ä»¥ä¸‹ä¸ºUDPç½‘ç»œéƒ¨åˆ†è§„åˆ™ -----
    # åˆ¤æ–­æ˜¯å¦å¼€å¯ä»£ç†UDP
    if [[ ${proxy_native_udp} || ${proxy_hotspot_udp} ]]; then
        #ipè·¯ç”±        
        `ip rule add fwmark 999 table 100 pref 100`
        `ip route add local default dev lo table 100`
        
        # åˆ¤æ–­æ˜¯å¦ä»£ç†æœ¬æœºUDP
        if [[ ${proxy_native_udp} ]]; then
            iptables -t mangle -I OUTPUT -p 17 ! --dport 53 -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT
            iptables -t mangle -I OUTPUT -p 17 ! --dport 53 -j MARK --set-mark 999
        fi
        
        iptables -t mangle -I PREROUTING ! -i tun+ -p 17 ! --dport 53 -j TPROXY --on-port ${udp_forward_port} --tproxy-mark 999
        
        # å¦‚æœä¸ä»£ç†ä¸æ”¾è¡Œå…±äº«UDPçš„è¯å°±ç¦ç½‘
        [[ ! ${proxy_hotspot_udp} && "æ”¾è¡Œ" != ${hotspot_udp} ]] && iptables -t mangle -I PREROUTING -s 192.168/16 -p 17 ! --dport 53 -j DROP
        
        #æ”¾è¡Œç‰¹æ®ŠIPæ®µï¼Œå¦åˆ™æ ¸å¿ƒåšUDPå›åº”ä¼šè¢«TPROXYä»£ç†é€ æˆæ— é™å›ç¯æˆ–è€…ä¸€äº›æƒ…æ™¯ä¸‹æ— æ³•å·¥ä½œ
        for ZJL in 127/8 10/8 100.64/10 172.16/12 255/8 224/4 240/4 169.254/16; do
            iptables -t mangle -I PREROUTING -d ${ZJL} -j ACCEPT
        done
        
        #æ”¾è¡Œç½‘å¡ï¼Œå¦åˆ™å¤–ç½‘IPå¯èƒ½æ— æ³•ä»£ç†UDP
        for ZJL in `ip addr | grep global | grep -E '[1-9]{1}[0-9]{0,2}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' | sed 's/inet \(.*\)\/.*/\1/'`; do
            iptables -t mangle -I PREROUTING -d ${ZJL} -j ACCEPT
        done
    fi
    
    
    # ----- ä»¥ä¸‹ä¸ºæœ¬æœºç½‘ç»œéƒ¨åˆ†è§„åˆ™ -----
    # åˆ¤æ–­æœ¬æœºç½‘ç»œæ˜¯å¦ä¸ºä»£ç†æˆ–è€…ç¦ç½‘
    if [[ "æ”¾è¡Œ" != ${release_native_uid} ]]; then
        # ç¦mengleé“¾
        iptables -t mangle -P OUTPUT DROP
        
        if [[ "ç¦ç½‘" != ${ban_native_uid} ]]; then
            # æ”¾è¡ŒTCPå’ŒDNS
            iptables -t mangle -I OUTPUT -p 6 -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT
            [[ "ç¦ç½‘" != ${native_dns} ]] && iptables -t mangle -I OUTPUT -p 17 --dport 53 -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT
            
            # è½¬å‘ TCP
            iptables -t nat -I OUTPUT -p 6 -j REDIRECT --to ${tcp_forward_port}
            # åˆ¤æ–­æœ¬æœºDNSæ˜¯å¦ä¸ºä»£ç†
            if [[ ! ${native_dns} ]]; then
                iptables -t nat -I OUTPUT -p 17 --dport 53 -j REDIRECT --to ${dns_forward_port}
            elif [[ "æ”¾è¡Œ" == ${native_dns} ]]; then
                iptables -t nat -I OUTPUT -p 17 --dport 53 -j ACCEPT
            fi
            
            # æ”¾è¡Œæ ¸å¿ƒ GID æˆ– UID
            local uid_or_gid
            [[ "tiny" == ${unlimited_data_way} ]] \
                && uid_or_gid="--uid ${forward_uid}" \
                || uid_or_gid="--gid 3004"
            iptables -t nat -I OUTPUT -m owner ${uid_or_gid} -j ACCEPT
        fi
        
        # åˆ¤æ–­æ˜¯å¦ç¦ç½‘å†…æ ¸
        local kernel="`get_configure ç³»ç»Ÿå†…æ ¸ | grep -E '^ç¦ç½‘|ç¦ç½‘TCP$'`"
        if [[ ${kernel} ]]; then
            [[ "ç¦ç½‘" == ${kernel} ]] || local protocol='-p 6'
            iptables -t mangle -I OUTPUT ${protocol} -m owner ! --uid 0-99999999 -j DROP || \
                iptables -t mangle -I OUTPUT ${protocol} -m owner ! --uid 0-99999 -j DROP
        fi
    fi
    
    
    # ----- ä»¥ä¸‹ä¸ºå…±äº«ç½‘ç»œéƒ¨åˆ†è§„åˆ™ -----
    
    # åˆ¤æ–­å…±äº«ç½‘ç»œæ˜¯å¦ä¸ºä»£ç†æˆ–è€…ç¦ç½‘
    if [[ "æ”¾è¡Œ" != ${hotspot_network} ]]; then
        # ç¦ç½‘ FORWARD é“¾
        iptables -t mangle -P FORWARD DROP
        
        # åˆ¤æ–­æ˜¯å¦ç¦æ­¢å…±äº«ipv6
        [[ "æ”¾è¡Œ" != ${ipv6_network} ]] && ip6tables -t mangle -P FORWARD DROP
        
        # åˆ¤æ–­å…±äº«ç½‘ç»œæ˜¯å¦ä¸ºä»£ç†
        if [[ "ç¦ç½‘" != ${hotspot_network} ]]; then
            # è½¬å‘ TCP
            iptables -t nat -I PREROUTING -s 192.168/16 -p 6 -j REDIRECT --to ${tcp_forward_port}
            # åˆ¤æ–­å…±äº«DNSæ˜¯å¦ä¸ºä»£ç†
            if [[ ! ${hotspot_dns} ]]; then
                #[[ "tiny" == ${unlimited_data_way} ]] && dns_forward_port="53"
                iptables -t nat -I PREROUTING -s 192.168/16 -p 17 --dport 53 -j REDIRECT --to ${dns_forward_port}
            elif [[ "æ”¾è¡Œ" == ${hotspot_dns} ]]; then
                iptables -t mangle -I FORWARD -p 17 --dport 53 -j ACCEPT
            elif [[ "ç¦ç½‘" == ${hotspot_dns} ]]; then
                iptables -t mangle -I PREROUTING -s 192.168/16 -p 17 --dport 53 -j DROP
            fi
        fi
        
        iptables -t nat -I PREROUTING -d 192.168/16 -j ACCEPT
        iptables -t mangle -I PREROUTING -d 192.168/16 -j ACCEPT
    fi
    
    
    # æ”¾è¡Œæœ¬æœºç½‘å¡
    for ZJL in $(get_configure æ”¾è¡Œç½‘å¡); do
        iptables -t nat -I OUTPUT -o ${ZJL} -j ACCEPT
        iptables -t mangle -I OUTPUT -o ${ZJL} -j ACCEPT
    done
    
    iptables -t nat -I OUTPUT -d 192.168/16 -j ACCEPT
    iptables -t mangle -I OUTPUT -d 192.168/16 -j ACCEPT
}


# æ¸¸æˆæµé‡è§„åˆ™ []<-()
game_rules() {
    # è¯»å–æ¸¸æˆé…ç½®
    local games="`get_configure æœ¬æœºæ¸¸æˆ`"
    # ä»£ç†åˆ™è¿”å›
    [[ ! `echo ${games} | grep -Ei "^(æ”¾è¡ŒUID|æ”¾è¡ŒUDP|ç¦ç½‘)$"` ]] && return
    
    # æ¸¸æˆåŒ…ååˆ—è¡¨: ç‹è€…è£è€€ã€QQé£è½¦ã€CFã€å’Œå¹³ç²¾è‹±ã€ä½¿å‘½å¬å”¤ã€ç«å½±å¿è€…ã€
    #                åŸç¥ã€ç¬¬äº”äººæ ¼ç½‘æ˜“ç‰ˆã€æ˜æ—¥ä¹‹åç½‘æ˜“ç‰ˆã€çƒçƒå¤§ä½œæˆ˜
    local package_names="com.tencent.tmgp.sgame com.tencent.tmgp.speedmobile \
                            com.tencent.tmgp.cf com.tencent.tmgp.pubgmhd \
                            com.tencent.tmgp.cod com.tencent.KiHan \
                            com.miHoYo.Yuanshen com.netease.mrzh \
                            com.netease.dwrg com.ztgame.bob"
    
    if [[ `echo "${games}" | grep -i "^æ”¾è¡ŒUID$"` ]]; then
        for ZJL in `package_to_uid "${package_names}"`; do
            release_uid "${ZJL}"
        done
    elif [[ "ç¦ç½‘" == ${games} ]]; then
        for ZJL in `package_to_uid "${package_names}"`; do
            iptables -t mangle -I OUTPUT -m owner --uid ${ZJL} -j DROP
        done
    else
        for ZJL in `package_to_uid "${package_names}"`; do
            iptables -t nat -I OUTPUT -p 17 -m owner --uid ${ZJL} -j ACCEPT
            iptables -t mangle -I OUTPUT -p 17 -m owner --uid ${ZJL} -j ACCEPT
        done
    fi
}


# æ¬¡è¦éƒ¨åˆ†çš„iptablesè§„åˆ™ []<-()
not_important_rules() {
    # ----- ä»¥ä¸‹ä¸ºæœ¬æœºç½‘ç»œéƒ¨åˆ†è§„åˆ™ -----
    
    # è¯»å–æ‰‹æœºåŒ…åå’Œuidåˆ—è¡¨
    package_uid_list="`grep -Eo "^[^ ]+ ([0-9])+" /data/system/packages.list`"
    
    # æ¸¸æˆiptablesè§„åˆ™
    game_rules
    
    # ç¦æ­¢æœ¬æœºUIDå¯¹åº”çš„è½¯ä»¶çš„ç½‘
    if [[ "ç¦ç½‘" != ${ban_native_uid} ]]; then
        for ZJL in `package_to_uid "${ban_native_uid}"`; do
            iptables -t mangle -I OUTPUT -m owner --uid ${ZJL} -j DROP
        done
    fi
    
    # æ”¾è¡Œæœ¬æœºUIDå¯¹åº”çš„åº”ç”¨
    if [[ "æ”¾è¡Œ" != ${release_native_uid} ]]; then
        for ZJL in `package_to_uid "${release_native_uid}"`; do
            release_uid "${ZJL}"
        done
    fi
    
    # åˆ¤æ–­æ˜¯å¦æ”¾è¡Œæœ¬æœºUDP
    if [[ "æ”¾è¡Œ" == ${native_udp} ]]; then
        iptables -t nat -I OUTPUT -p 17 ! --dport 53 -j ACCEPT
        iptables -t mangle -I OUTPUT -p 17 ! --dport 53 -j ACCEPT
    fi
    
    # æ”¾è¡Œæœ¬æœºUIDå¯¹åº”çš„è½¯ä»¶çš„UDP
    for ZJL in `package_to_uid "$(get_configure æ”¾è¡ŒUDP)"`; do
        iptables -t nat -I OUTPUT -m owner --uid ${ZJL} -p 17 ! --dport 53 -j ACCEPT
        iptables -t mangle -I OUTPUT -m owner --uid ${ZJL} -p 17 ! --dport 53 -j ACCEPT
    done
    
    local release_native_https="`get_configure æ”¾è¡ŒHTTPS`"
    # æ”¾è¡Œæœ¬æœºHTTPS
    if [[ "æ”¾è¡Œ" == ${release_native_https} ]]; then
        iptables -t nat -I OUTPUT -p 6 --dport 443 -j ACCEPT
        iptables -t mangle -I OUTPUT -p 6 --dport 443 -j ACCEPT
        
    else
        # æ”¾è¡Œæœ¬æœºUIDå¯¹åº”çš„è½¯ä»¶çš„HTTPS
        for ZJL in `package_to_uid "${release_native_https}"`; do
            iptables -t nat -I OUTPUT -p 6 --dport 443 -m owner --uid ${ZJL} -j ACCEPT
            iptables -t mangle -I OUTPUT -p 6 --dport 443 -m owner --uid ${ZJL} -j ACCEPT
        done
    fi
    
    # æ”¾è¡Œï¼ˆQQ && TIM && å¾®ä¿¡ï¼‰çš„ UDP 8000 ç«¯å£ï¼Œä¸ºç½‘ç»œç”µè¯ä½¿ç”¨çš„ç«¯å£
    if [[ "æ”¾è¡Œ" == "`get_configure QQå¾®ä¿¡ç”µè¯`" ]]; then
        for ZJL in `package_to_uid "tencent.mobileqq tencent.tim tencent.mm"`; do
            iptables -t nat -I OUTPUT -p 17 --dport 8000 -m owner --uid ${ZJL} -j ACCEPT
            iptables -t mangle -I OUTPUT -p 17 --dport 8000 -m owner --uid ${ZJL} -j ACCEPT
        done
    fi
    
    # æ”¾è¡Œæœ¬æœºTCPç«¯å£
    release_uid_ports "6" "`get_configure æ”¾è¡ŒTCPç«¯å£`"
    # æ”¾è¡Œæœ¬æœºUDPç«¯å£
    release_uid_ports "17" "`get_configure æ”¾è¡ŒUDPç«¯å£`"
    
    
    # ----- ä»¥ä¸‹ä¸ºå…±äº«ç½‘ç»œéƒ¨åˆ†è§„åˆ™ -----
    
    # åˆ¤æ–­æ˜¯å¦æ”¾è¡Œå…±äº«UDP
    if [[ "æ”¾è¡Œ" == ${hotspot_udp} ]]; then
        iptables -t mangle -I FORWARD -p 17 ! --dport 53 -j ACCEPT
        iptables -t nat -I PREROUTING -s 192.168/16 -p 17 ! --dport 53 -j ACCEPT
    fi
    
    hotspot_https="`get_configure å…±äº«HTTPS`"
    if [[ "æ”¾è¡Œ" == ${hotspot_https} ]]; then
        iptables -t mangle -I FORWARD -p 6 --dport 443 -j ACCEPT
        iptables -t nat -I PREROUTING -s 192.168/16 -p 6 --dport 443 -j ACCEPT
        
    elif [[ "ç¦ç½‘" == ${hotspot_https} ]]; then
        iptables -t mangle -I PREROUTING -s 192.168/16 -p 6 --dport 443 -j DROP
    fi
    
    # æ”¾è¡Œå…±äº«TCPç«¯å£
    release_hotspot_ports "6" "`get_configure å…±äº«TCPç«¯å£`"
    
    # æ”¾è¡Œå…±äº«UDPç«¯å£
    release_hotspot_ports "17" "`get_configure å…±äº«UDPç«¯å£`"
}


# ç”¨HTTPè§£æHostçš„IP []<-(host:String)
http_analysis_host_to_ip() {
    [[ ${2} ]] && local time_out="${2}" || local time_out="2"
    local ip=`MLBox -http="http://119.29.29.29/d?dn=${1}" -timeout=${time_out} | grep -Ev "timeout|httpGetResponse"`
    echo "${ip%%\;*}"
}


# æ£€æµ‹è”ç½‘ []<-(time_out:Integer)
detect_internet_connectivity() {
    # è¶…æ—¶æ—¶é—´(å•ä½ç§’)
    [[ ${1} ]] && local time_out="${1}" || local time_out="2"
    local interface_ip
    
    # åˆ¤æ–­æ˜¯å¦å¼€å¯æ£€æµ‹è”ç½‘åŠŸèƒ½
    if [[ ${check_extranet_way} ]]; then
        # é€šè¿‡MLBoxæ£€æµ‹ç½‘ç»œè¿æ¥
        case ${check_extranet_way} in
            a|A)
                # ç™¾åº¦ çš„æ¥å£
                interface_ip="`http_analysis_host_to_ip 'opendata.baidu.com' "${time_out}"`"
                
                # åˆ¤æ–­HTTPæ˜¯å¦è”ç½‘æˆåŠŸ
                if [[ ${interface_ip} ]]; then
                    extranet_http="âˆš"
                    extranet_ip="`MLBox -http="-address=${interface_ip}:443 -url=https://opendata.baidu.com/api.php?query=ip&co=&resource_id=6006&ie=utf8&oe=utf8" -timeout=${time_out}`"
                    
                    [[ "0" == `get_json_value "${extranet_ip}" "status"` ]] \
                        && extranet_ip="IPï¼š`get_json_value "${extranet_ip}" "origip"`\næ¥è‡ªï¼š`get_json_value "${extranet_ip}" "location"`" \
                        || extranet_ip=""
                fi
            ;;
            b|B)
                # ç«™é•¿ä¹‹å®¶ çš„æ¥å£
                interface_ip="`http_analysis_host_to_ip 'mip.chinaz.com' "${time_out}"`"
                
                # åˆ¤æ–­HTTPæ˜¯å¦è”ç½‘æˆåŠŸ
                if [[ ${interface_ip} ]]; then
                    extranet_http="âˆš"
                    extranet_ip="`MLBox -http="-address=${interface_ip}:443 -url=https://mip.chinaz.com/" -timeout=${time_out} | grep -Ei 'æ‚¨çš„IP|æ•°æ®ä¸€' \
                             | sed 's/<[^>]*>//g;s/.*åœ°å€ï¼š/IP: /;s/.*æ•°æ®ä¸€ï¼š/æ¥è‡ª: /'`"
                fi
            ;;
            c|C)
                # ipip.net çš„æ¥å£
                interface_ip="`http_analysis_host_to_ip 'myip.ipip.net' "${time_out}"`"
                
                # åˆ¤æ–­HTTPæ˜¯å¦è”ç½‘æˆåŠŸ
                if [[ ${interface_ip} ]]; then
                    extranet_http="âˆš"
                    extranet_ip="`MLBox -http="-address=${interface_ip}:443 -url=https://myip.ipip.net/" -timeout=${time_out} | grep -E 'IP|æ¥è‡ª' \
                             | sed 's/.*IPï¼š/IP: /;s/[ ]*æ¥è‡ªäºï¼š/\næ¥è‡ª: /;s/| //'`"
                fi
            ;;
        esac
        
        # åˆ¤æ–­HTTPSæ˜¯å¦è”ç½‘æˆåŠŸ
        [[ ${extranet_ip} ]] && extranet_https="âˆš"
    fi
    
    # åˆ¤æ–­æ˜¯å¦å¼€å¯æ£€æµ‹UDP
    if [[ ${check_extranet_udp} && ${proxy_native_udp} ]] && [[ ${extranet_ip} || ! ${check_extranet_way} ]]; then
        [[ `MLBox -ntp '119.29.186.53' -timeout=${time_out} | grep 'æ—¶é—´æˆ³'` ]] \
            && extranet_udp="âˆš" \
            || extranet_udp="Ã—"
    fi
}


# æ˜¾ç¤ºè¾“å‡ºç•Œé¢ []<-()
show_display() {
    # åˆ†å‰²çº¿
    dividing_line="__________________________"
    
    # è¾“å‡ºä¸¤ä¸ªç©ºè¡Œ
    echo "\n"
    
    output_dividing_line
    center_output "ZJL 2.0" "not_exist"
    [[ ${is_busybox_exist} ]] || center_output "æ—  BusyBox ä½¿ç”¨    " "above"
    [[ ${is_udp_supported} ]] && center_output "æœ¬æœºä¸æ”¯æŒ UDP ä»£ç†  " "above"
    [[ ${is_multiport_support} ]] || center_output "æœ¬æœºä¸æ”¯æŒæ”¾è¡Œç«¯å£èŒƒå›´  " "above"
    [[ ${is_support_double_sim_mode} ]] && center_output "æœ¬æœºä¸æ”¯æŒåŒå¡åˆ†åˆ«æ¨¡å¼  " "above" && center_output "ç°åœ¨å°†ä½¿ç”¨å¡1æ¨¡å¼    " "above"
    
    output_dividing_line
    # ä¸æ˜¯æ‰§è¡Œæ£€æµ‹ å°±æ£€æµ‹æ ¸å¿ƒçŠ¶æ€
    [[ ${script_execution_state} ]] && read_core_state
    
    # è¾“å‡ºå½“å‰ä½¿ç”¨çš„å…æµæ ¸å¿ƒçŠ¶æ€
    if [[ ${core_pid} ]]; then
        center_output "æ ¸å¿ƒ: ${core_name} âˆš  " "not_exist"
    else
        center_output "æ ¸å¿ƒ: å•¥éƒ½æ²¡å¼€ Ã—   " "not_exist"
        
        # æ ¸å¿ƒä¸ºå…³é—­å°±å…³é—­æ£€æµ‹ç½‘ç»œ
        check_extranet_way=""
        check_extranet_udp=""
        
        # è¯»å–æ˜¯å¦æœ‰å¼€å¯å¤±è´¥çš„é”™è¯¯ä¿¡æ¯
        if [[ ${core_start_error_info} ]]; then
            output_dividing_line "not_exist"
            center_output "å¼€å¯å¤±è´¥çš„é”™è¯¯ä¿¡æ¯:  " "above"
            
            echo "${core_start_error_info}" | while read ZJL; do
                center_output "${ZJL}    " "above"
            done
        fi
    fi
    
    # åˆ¤æ–­æ ¸å¿ƒæ˜¯å¦å¼€å¯
    if [[ ${core_pid} ]]; then
        # è¾“å‡ºæ¨¡å¼å
        center_output "æ¨¡å¼: ${core_mode_name}    " "above"
    else
        # åˆ¤æ–­å½“å‰æ¨¡å¼æ˜¯å¦æ­£å¸¸
        if [[ ${mode_file_state} && "normal" != ${mode_file_state} ]]; then
            output_dividing_line
            
            # è¾“å‡ºæ¨¡å¼æ–‡ä»¶å½“å‰çŠ¶æ€
            case ${mode_file_state} in
                no_selected_mode_file)
                    center_output "æ²¡æ‰¾åˆ° ${select_mode_file}.conf    "
                    center_output "è¯·å» [é€‰æ‹©æ¨¡å¼] é‡Œé‡å¡«  " "not_exist"
                ;;
                please_select)
                    find "${mode_path}" -type f -maxdepth 1 -iname "*.conf" | while read ZJL; do
                        center_output "æ¨¡å¼: ${ZJL##*/}    "
                    done
                    center_output "è¯·ä½¿ç”¨ [é€‰æ‹©æ¨¡å¼] åŠŸèƒ½  " "not_exist"
                ;;
                no_content)
                    center_output "æ¨¡å¼å†…å®¹ä¸ºç©º  " "not_exist"
                ;;
                no_mode_file)
                    center_output "è¯·æ·»åŠ æ¨¡å¼  " "not_exist"
                ;;
            esac
        fi
    fi
    
    # åˆ¤æ–­æ˜¯å¦å¼€å¯å¿«é€Ÿå¯åŠ¨åŠŸèƒ½
    if [[ ! ${quickly_open_scripts} ]]; then
        output_dividing_line
        # è·å–WIFIçš„ç½‘å¡
        local wifi_net_card="`getprop wifi.interface`"
        wifi_net_card="${wifi_net_card:-"`dumpsys connectivity | grep -wi 'type: WIFI' | grep -o 'InterfaceName: [^ ]*' | grep -o '[^: ]*$'`"}"
        wifi_net_card="${wifi_net_card:-"`dumpsys netstats | grep -i 'iface' | grep -wi "type=WIFI" | sed -n 's/.*iface=\(.*\) ident.*/\1/g;1p'`"}"
        wifi_net_card="${wifi_net_card:-"`ip route | grep -oi 'wlan[^ ]*'`"}"
        
        # è·å–WIFIç½‘ç»œä¿¡æ¯
        local netstats_info="`dumpsys connectivity | grep -wi 'type: WIFI'`"
        
        # åˆ¤æ–­æ˜¯å¦è¿æ¥WiFi
        [[ ${netstats_info} ]] && local is_wifi_open="open"
        
        if [[ ${is_wifi_open} ]]; then
            center_output "ç½‘ç»œ: WIFI å·²è¿æ¥ âˆš  "
            # è·å–WiFi SSID
            local wifi_name="`echo "${netstats_info}" | grep -o 'SSID: "[^ ]*"' | sed -r 's/.*"(.*)"/\1/'`"
            
            if [[ ${wifi_name} ]]; then
                # è¾“å‡º WiFiåå­—
                center_output "åç§°: ${wifi_name}   " "not_exist"
                
                # è·å–WiFiå¯†ç 
                local wifi_password
                if [ -s /data/misc/apexdata/com.android.wifi/WifiConfigStore.xml ]; then
                    wifi_password="`grep -wA 3 '<string name="SSID">&quot;'${wifi_name}'' /data/misc/apexdata/com.android.wifi/WifiConfigStore.xml \
                                    | sed -n 's/.*<string name="PreSharedKey">&quot;\(.*\)&quot.*/\1/p'`"
                
                elif [ -s /data/misc/wifi/WifiConfigStore.xml ]; then
                    wifi_password="`grep -wA 3 '<string name="SSID">&quot;'${wifi_name}'' /data/misc/wifi/WifiConfigStore.xml \
                                    | sed -n 's/.*PreSharedKey">&quot;\(.*\)&quot.*/\1/p'`"
                
                elif [ -s /data/misc/wifi/wpa_supplicant.conf ]; then
                    wifi_password="`grep -wA 3 'ssid="'${wifi_name}'"' /data/misc/wifi/wpa_supplicant.conf \
                                    | sed -n 's/.*psk="\(.*\)".*/\1/p'`"
                fi
                
                # è¾“å‡º WiFiå¯†ç 
                if [[ ${wifi_password} ]]; then
                    center_output "å¯†ç : `echo "${wifi_password}" | sed -n '1p'`  " "above"
                fi
            else
                center_output "è·å–WiFiåå’Œå¯†ç å¤±è´¥    " "not_exist"
            fi
            
            # è¾“å‡º WiFi ä½¿ç”¨æµé‡æ•°
            get_net_card_traffic "${wifi_net_card}"
            
        else
            # â€”â€”â€”å½“å‰ä½¿ç”¨çš„æ˜¯æµé‡â€”â€”â€”
            
            # è·å–æµé‡ç½‘å¡
            local net_card="`dumpsys connectivity | grep 'NetworkAgentInfo{' | grep 'type: MOBILE' | grep -Eiv 'extra: ims' | grep -o 'InterfaceName: [^ ]*' | grep -o '[^: ]*$'`"
            net_card="${net_card:-"`dumpsys netstats | grep -i 'iface=' | grep 'metered=true' | grep -Eio -m 1 'rmnet[^ ]*|ccmni[^ ]*'`"}"
            net_card="${net_card:-"`ip route | grep -Eio -m 1 'rmnet[^ ]*|ccmni[^ ]*'`"}"
            
            # è·å–å†…ç½‘IP
            [[ ${net_card} ]] && local intranet_ip="`ip -4 addr | grep -w ${net_card} | sed -rn 's/.*inet (.*)\/.*/\1/p'`"
            
            # åˆ¤æ–­æ˜¯å¦èƒ½è¯»å–åˆ°æµé‡å†…ç½‘IP
            if [[ ${intranet_ip} ]]; then
                # è¾“å‡ºå†…ç½‘IP
                center_output "å†…ç½‘: ${intranet_ip} "
                
                # åªæœ‰æ‰§è¡Œå¼€å¯å’Œæ£€æµ‹çš„æ—¶å€™ å¼€å¯äº†æ£€æµ‹åŠŸèƒ½æ‰ä¼šå¼€å§‹æ£€æµ‹ç½‘ç»œ
                if [[ "close" != ${script_execution_state} ]] && [[ ${check_extranet_way} || ${check_extranet_udp} ]]; then
                    local check_extranet_state="ON"
                    # åˆ¤æ–­æ˜¯å¦å­˜åœ¨MLBoxæ¨¡å—
                    [[ ${is_MLBox_exist} ]] && detect_internet_connectivity "2" || check_extranet_state="MLBoxNoExist"
                fi
                
                # é‡æ–°è·å–ç½‘ç»œä¿¡æ¯
                netstats_info="`dumpsys connectivity | grep 'NetworkAgentInfo{' | grep "InterfaceName: ${net_card}"`"
                # è·å– APN
                local apn="`echo "${netstats_info}" | sed 's/.*extra: \([^,]*\),.*/\1/'`"
                # è·å–APN ä»£ç†å’Œç«¯å£ ä¿¡æ¯
                local apn_agent_and_port="`echo "${netstats_info}" | sed -rn 's/.*HttpProxy: \[(.*)\] ([0-9]{2,5}).*/\1 \2/p'`"
                # è¾“å‡ºæ¥å…¥ç‚¹
                [[ ${apn_agent_and_port} ]] && center_output "APN: ${apn} ${apn_agent_and_port}  " "not_exist" || center_output "APN: ${apn} ä»£ç†ç•™ç©º      " "not_exist"
                
                # è¾“å‡ºæ•°æ®ä½¿ç”¨æµé‡æ•°
                get_net_card_traffic "${net_card}"
                
                # åˆ¤æ–­æ£€æµ‹è”ç½‘çŠ¶æ€
                case ${check_extranet_state} in
                    ON)
                        # åˆ¤æ–­æ˜¯å¦å¼€å¯æ£€æµ‹è”ç½‘åŠŸèƒ½
                        if [[ ${check_extranet_way} ]]; then
                            output_dividing_line
                            center_output "HTTP è”ç½‘ ${extranet_http:="Ã—"}   HTTPS è”ç½‘ ${extranet_https:="Ã—"}  " "not_exist"
                                            
                            if [[ ${extranet_ip} ]]; then
                                echo "${extranet_ip}" | while read ZJL; do
                                    center_output "${ZJL}  " "above"
                                done
                            else
                                center_output "æŸ¥è¯¢å¤–ç½‘IPå¤±è´¥    "  "above"
                            fi
                        fi
                        
                        # åˆ¤æ–­æ˜¯å¦æ£€æµ‹äº†UDP
                        if [[ ${extranet_udp} ]]; then
                            output_dividing_line
                            center_output "UDP è¿æ¥ ${extranet_udp} " "not_exist"
                        fi
                    ;;
                    MLBoxNoExist)
                        output_dividing_line
                        center_output "[æ£€æµ‹è”ç½‘]å’Œ[æ£€æµ‹UDPè”ç½‘]éœ€è¦MLBox    "
                        center_output "è¯·å°†MLBoxæ¨¡å—å¤åˆ¶è¿›æ¨¡å—æ–‡ä»¶å¤¹    " "not_exist"
                    ;;
                esac
                
            else
                center_output "ç½‘ç»œ: æ•°æ®éƒ½æ²¡å¼€ Ã—  " "not_exist"
            fi
            
            # è·å–çƒ­ç‚¹ç½‘å¡
            local hotspots_net_card="`ip route | grep -Eio "${wifi_net_card}|wlan.|ap.|softap."`"
            
            # åˆ¤æ–­çƒ­ç‚¹æ˜¯å¦å¼€å¯
            if [[ ! ${is_wifi_open} && ${hotspots_net_card} ]] || [[ ${is_wifi_open} && `echo "${hotspots_net_card}" | grep -v "${wifi_net_card}"` ]]; then
                output_dividing_line
                # åˆ¤æ–­æ˜¯å¦åŒæ—¶å¼€WiFiå’Œçƒ­ç‚¹                               
                [[ ${is_wifi_open} ]] && hotspots_net_card="`echo "${hotspots_net_card}" | grep -v "${wifi_net_card}"`"
                # è·å–çƒ­ç‚¹è¿æ¥æ•°
                local hotspots_connect="`grep '0x2' /proc/net/arp | grep -c "${hotspots_net_card}"`"
                # è·å–çƒ­ç‚¹è¿æ¥è®¾å¤‡æ•°
                center_output "çƒ­ç‚¹: ${hotspots_connect} ä¸ªå·²è¿æ¥   "
                
                # è·å–çƒ­ç‚¹çš„åå­—å’Œå¯†ç 
                if [ -s /data/misc/apexdata/com.android.wifi/WifiConfigStoreSoftAp.xml ]; then
                    local hotspot="`grep -E '(<string name="SSID">)|(<string name="Passphrase">)' /data/misc/apexdata/com.android.wifi/WifiConfigStoreSoftAp.xml`"
                    local hotspot_name="`echo "${hotspot}" | sed -n 's/.*name="SSID">\(.*\)<\/string>.*/\1/p'`"
                    local hotspot_password="`echo "${hotspot}" | sed -n 's/.*name="Passphrase">\(.*\)<\/string>.*/\1/p'`"
                elif [ -s /data/misc/wifi/softap.conf ]; then
                    local hotspot="`sed -r $'s/\u0004/\u00A0/g;s/\u0006/\u00A0/g;s/[\u0001-\u001F]//g' /data/misc/wifi/softap.conf`"
                    local hotspot_name="`echo ${hotspot} | sed -r $'s/^\u00A0//;s/\u00A0.*//g'`"
                    local hotspot_password="`echo ${hotspot} | grep $'\u00A0' | sed $'s/.*\u00A0//'`"
                fi
                
                # è¾“å‡ºçƒ­ç‚¹ä¿¡æ¯
                if [[ ${hotspot_name} ]]; then
                    center_output "hotspot_name: ${hotspot_name}    " "not_exist"
                    [[ ${hotspot_password} ]] && center_output "hotspot_password: ${hotspot_password}    " "above"
                else
                    center_output "è·å–çƒ­ç‚¹åå’Œå¯†ç å¤±è´¥   " "not_exist"
                fi
                
                # åˆ¤æ–­æ˜¯å¦å­˜åœ¨busybox
                if [[ ${is_busybox_exist} ]]; then
                    # è·å–å…±äº«ç½‘ç»œä½¿ç”¨æµé‡æ•°
                    local flow="`ifconfig "${hotspots_net_card}" | grep 'TX bytes' | sed 's/.*TX bytes:.*(\(.*B\)).*/\1/;s/i.*//'`"
                    # è¾“å‡ºå…±äº«ç½‘ç»œä½¿ç”¨æµé‡æ•°
                    [[ "0.0 B" == ${flow} || ! ${flow} ]] && center_output "å·²ç”¨: æ²¡æŸ¥åˆ° Ã—  " "above" || center_output "å·²ç”¨: ${flow}  " "above"
                fi
            fi
        fi
            
    fi
    
    
    # è·å–å°å°¾å·´å†…å®¹
    local output_tail="`echo "${configure_file_content_dungeon#*å°å°¾å·´=}"`"
    
    # è¾“å‡ºå°å°¾å·´å†…å®¹
    if [[ ${output_tail} ]]; then
        output_dividing_line "not_exist"
        
        echo "${output_tail}" | while IFS= read ZJL; do
            center_output "${ZJL}  " "above"
        done
    fi
    
    output_dividing_line
}


# åˆå§‹åŒ– [Boolean]<-()
init_zjl() {
    # æ¨¡å—è·¯å¾„
    module_path="${0%/*}"
    # é˜²è·³è·¯å¾„
    zjl_path="${module_path%/*}"
    # æ¨¡å¼è·¯å¾„
    mode_path="${zjl_path}/config"
    
    # åˆ‡æ¢å½“å‰è·¯å¾„ä¸ºé˜²è·³è·¯å¾„
    cd ${zjl_path}
    
    # å¤„ç†æ¨¡å—è·¯å¾„æ‹¬å·é—®é¢˜
    local processed_module_path="${module_path}"
    for ZJL in '(' ')' 'ï¼ˆ' 'ï¼‰';do
        processed_module_path="${processed_module_path//${ZJL}/\\${ZJL}}"
    done
    
    # è„šæœ¬è¿è¡Œæ‰€éœ€å‘½ä»¤
    local command_requireds="ln mv rm ip sed find grep pgrep pkill mkdir chmod zjl"
    local no_exist_commands
    
    # åˆ¤æ–­æ˜¯å¦æœ‰ç¼ºå¤±çš„å‘½ä»¤
    if [[ `type ${command_requireds}` == *found* ]]; then
        # è·å–ç¼ºå¤±å‘½ä»¤çš„åˆ—è¡¨
        for ZJL in ${command_requireds}; do
            [[ `type ${ZJL}` == *found* ]] && no_exist_commands="${ZJL} ${no_exist_commands}"
        done
    fi
    
    # åˆ¤æ–­æ˜¯å¦å­˜åœ¨busybox
    if [[ `type busybox` != *found* ]] || [ -s ${module_path}/busybox ]; then
        # åˆ¤æ–­ç³»ç»Ÿæ˜¯å¦å­˜åœ¨ busyboxï¼Œæ²¡æœ‰å°†ä½¿ç”¨æ¨¡å—æ–‡ä»¶å¤¹é‡Œçš„
        [[ `type busybox` != *found* ]] || alias busybox="${processed_module_path}/busybox"
        
        for ZJL in ${no_exist_commands} ifconfig; do
            # è®¾ç½®å‘½ä»¤åˆ«å
            alias ${ZJL}="busybox ${ZJL}"
        done
        
        # è¡¨ç¤ºå½“å‰è„šæœ¬ä½¿ç”¨äº† busybox
        is_busybox_exist="true"
    elif [[ ${no_exist_commands} ]]; then
        # è¾“å‡ºè„šæœ¬æ‰€éœ€è¦çš„å‘½ä»¤ç¼ºå¤±æç¤º
        echo "\n      __________________________\n\n"\
              "              ZJL 2.0\n\n"\
              "          æ— busyboxå¯åŠ¨å¤±è´¥\n"\
              "     __________________________\n\n"\
              "         æ‰‹æœºéœ€å†…ç½®ä»¥ä¸‹å‘½ä»¤\n\n"\
              "         ln mv rm ip sed\n\n"\
              "         find grep pkill\n\n"\
              "         pgrep mkdir chmod\n\n"\
              "         æ‰€ä»¥è¯·å®‰è£…busybox\n\n"\
              "        æˆ–å¤åˆ¶åˆ°æ¨¡å—æ–‡ä»¶å¤¹é‡Œ\n"\
              "     __________________________"
        # å…³é—­æ•°æ®
        svc data disable
        
        # é‡Šæ”¾ç½‘ç»œ
        iptables -D OUTPUT ! -o wlan+ -j DROP
        iptables -D FORWARD -j DROP
        
        # é€€å‡ºè„šæœ¬
        exit
    fi
    
    
    # åˆ¤æ–­æ¨¡å—æ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨MLBox
    if [ -s ${module_path}/MLBox ]; then
        alias MLBox="${processed_module_path}/MLBox"
        is_MLBox_exist="true"
    fi
    
    for ZJL in ${zjl_path} ${mode_path} ${module_path}; do
        # åˆ é™¤bakåç¼€å¤‡ä»½æ–‡ä»¶
        `rm -f ${ZJL}/*.bak`
        # èµ‹äºˆæ–‡ä»¶æƒé™
        `chmod -R 777 ${ZJL}`
    done
    
    # åˆ¤æ–­æ‰‹æœºæ˜¯å¦æ”¯æŒ multiport æ¨¡å—
    [[ `grep -i '^multiport$' /proc/net/ip_tables_matches` ]] && is_multiport_support='true'
    
    
    # è¯»å–é˜²è·³é…ç½®æ–‡ä»¶ï¼Œå¹¶è¿‡æ»¤ä»¥ // å’Œ # ä¸ºå¼€å¤´çš„æ³¨é‡Šå†…å®¹
    configure_file_content_dungeon="`sed 's/\/\/.*$//;s/#.*$//;/^[ ]*$/d;s/[ ]*=/=/g' ${zjl_path}/*.ini | grep -v '^.*=$'`"
    configure_file_content="`echo "${configure_file_content_dungeon}" | sed 's/[[:space:]][[:space:]]*/ /g;s/=[ ]*/=/g;s/ $//g;'`"
    
    # è¯»å–é…ç½®
    release_native_uid="`get_configure æ”¾è¡Œè½¯ä»¶`"
    ban_native_uid="`get_configure ç¦ç½‘è½¯ä»¶`"
    native_udp="`get_configure æœ¬æœºUDP`"
    native_dns="`get_configure æœ¬æœºDNS | grep -Ei '^æ”¾è¡Œ|ç¦ç½‘$'`"
    hotspot_network="`get_configure å…±äº«ç½‘ç»œ | grep -Ei '^æ”¾è¡Œ|ç¦ç½‘$'`"
    hotspot_udp="`get_configure å…±äº«UDP`"
    hotspot_dns="`get_configure å…±äº«DNS | grep -Ei '^æ”¾è¡Œ|ç¦ç½‘$'`"
    unlimited_data_way="`get_configure å…æµæ–¹å¼ | grep -Ei '^tiny|clnc$'`"
    select_mode_file="`get_configure é€‰æ‹©æ¨¡å¼`"
    ipv6_network="`get_configure æ‰‹æœºIPv6`" 
    check_extranet_way="`get_configure æ£€æµ‹è”ç½‘ | grep -Ei '^[abcd]$'`"
    check_extranet_udp="`get_configure æ£€æµ‹UDPè”ç½‘ | grep '^å¼€å¯$'`"
    quickly_open_scripts="`get_configure å¿«é€Ÿå¯åŠ¨ | grep '^å¼€å¯$'`"
    on_off_network="`get_configure å¼€å…³æ•°æ® | grep '^å¼€å¯$'`"
    
    
    # åˆ¤æ–­æ˜¯å¦æ‰§è¡Œçš„ä¸ºå¼€å¯
    if [[ "open" == ${script_execution_state} ]]; then
        # åˆ¤æ–­æ˜¯å¦æŒ‡å®šäº†åŒæ¨¡å¼
        if [[ `echo "${select_mode_file}" | grep '/'` ]]; then
            is_double_sim_mode="true"
            local sim_subid_info="`dumpsys isub | grep -Ei 'SubId\[|defaultDataSubId='`"
            
            # åˆ¤æ–­æ˜¯å¦èƒ½è·å–åˆ°SIMä¿¡æ¯
            if [[ ${sim_subid_info} ]]; then
                local current_sim_subid="`echo "${sim_subid_info}" | grep -i 'default' | grep -o '[0-9]'`"
                local sim_first_subid="`echo "${sim_subid_info}" | grep -i 'SubId\[0\]' | sed -r 's/.*([0-9]).*/\1/'`"
                local sim_second_subid="`echo "${sim_subid_info}" | grep -i 'SubId\[1\]' | sed -r 's/.*([0-9]).*/\1/'`"
            fi
            
            if [[ ${current_sim_subid} && ${sim_first_subid}${sim_second_subid} ]]; then
                [[ ${current_sim_subid} == ${sim_first_subid} ]] && select_mode_file="${select_mode_file%/*}" || select_mode_file="${select_mode_file#*/}"
            else
                is_support_double_sim_mode="false"
                select_mode_file="${select_mode_file%/*}"
            fi
        fi
        
        # æŸ¥çœ‹æ¨¡å¼æ–‡ä»¶çŠ¶æ€ï¼Œæ­£å¸¸ä¸ºç©º
        if [[ `find "${mode_path}" -maxdepth 1 -type f -iname "*.conf"` ]]; then
            # åˆ¤æ–­æ˜¯å¦æŒ‡å®šäº†æ¨¡å¼å
            if [[ ${select_mode_file} ]]; then
                mode="${select_mode_file}.conf"
                # åˆ¤æ–­æ˜¯å¦æ‰¾åˆ°é…ç½®é‡Œé€‰æ‹©çš„æ¨¡å¼æ–‡ä»¶
                [[ ! `find "${mode_path}" -maxdepth 1 -type f -name "${mode}"` ]] && mode_file_state="no_selected_mode_file"
            else
                mode="*.conf"
                # åˆ¤æ–­æ˜¯å¦æœ‰å¤šä¸ªæ¨¡å¼æ–‡ä»¶
                [ 1 -lt `find "${mode_path}" -maxdepth 1 -type f -iname "${mode}" | grep -c ".conf$"` ] && mode_file_state="please_select"
            fi
            
            if [[ ! ${mode_file_state} ]]; then
                # åˆ¤æ–­æ¨¡å¼æ–‡ä»¶æœ‰æ²¡æœ‰å†…å®¹
                if [ -s ${mode_path}/${mode} ]; then
                    mode_file_state="normal"
                    # æ¨¡å¼æ­£å¸¸å°±é‡å†™æ¨¡å¼è·¯å¾„
                    mode="`find "${mode_path}" -maxdepth 1 -type f -name "${mode}"`"
                else
                    mode_file_state="no_content"
                fi
            fi
        else
            # æ²¡æ‰¾åˆ°æ¨¡å¼æ–‡ä»¶
            mode_file_state="no_mode_file"
        fi
    
    # åˆ¤æ–­æ˜¯å¦æ‰§è¡Œçš„ä¸ºæ£€æµ‹
    elif [[ ! ${script_execution_state} ]]; then
        # ä»å·²è¿è¡Œçš„æ ¸å¿ƒå†…è¯»å–å…æµæ–¹å¼å’Œæ¨¡å¼è·¯å¾„
        read_core_state
        
        # å¦‚æœæ ¸å¿ƒå¼€å¯äº†å°±è¯»å–ç«¯å£å’Œä¸€äº›é…ç½®
        [[ ${core_mode_name} ]] && read_mode_port
    fi
    
    return 0
}


# å…³é—­é˜²è·³ []<-()
close_zjl() {
    sleep 0.1
    
    # å…³é—­æ ¸å¿ƒ
    `pkill "tiny|clnc"`
    
    # æ¸…ç†ipè·¯ç”±è§„åˆ™
    `ip rule del fwmark 999 table 100 pref 100`
    `ip route del local default dev lo table 100`
    # è§£é™¤ç¦æ­¢æœ¬æœºipv6
    `ip -6 rule del unreachable pref 100`
    ip6tables -t mangle -F OUTPUT
    # è§£é™¤ç¦æ­¢å…±äº«ipv6
    ip6tables -t mangle -P FORWARD ACCEPT
    
    # æ¸…é™¤iptablesè§„åˆ™        
    iptables -t nat -F OUTPUT
    iptables -t nat -F PREROUTING
    
    for ZJL in OUTPUT FORWARD PREROUTING; do
        iptables -t mangle -F ${ZJL}
        iptables -t mangle -P ${ZJL} ACCEPT
    done
    
    # é‡Šæ”¾ç½‘ç»œ
    iptables -D OUTPUT ! -o wlan+ -j DROP
    iptables -D FORWARD -j DROP
    iptables -D OUTPUT ! -o wlan+ -m owner ! --gid 3004 -j DROP
    
    # è°ƒç”¨å¼€æœºè‡ªå¯å‡½æ•°
    boot_auto_on
}


# å¼€å¯é˜²è·³ [Boolean]<-()
open_zjl() {
    # å¦‚æœæ¨¡å¼ä¸ºä¸æ­£å¸¸ï¼Œå°±é€€å‡ºå‡½æ•°
    [[ "normal" != ${mode_file_state} ]] && return 1
    
    # è¯»å–æ¨¡å¼åŠç«¯å£
    read_mode_port
    
    # è·å–GID å¯åŠ¨æ ¸å¿ƒ
    if [[ 'clnc' == "${unlimited_data_way}" ]]; then
        [[ ${on_off_network} ]] && sleep 0.2
        # ç¦æ­¢ç½‘ç»œ æ”¹ä¸ºæ”¾è¡ŒGID
        iptables -D OUTPUT ! -o wlan+ -j DROP
        iptables -I OUTPUT ! -o wlan+ -m owner ! --gid 3004 -j DROP
        
        # å¤„ç†æ¨¡å¼ å…³é—­Tunæ¨¡å— å†™å…¥ä¸´æ—¶æ¨¡å¼æ–‡ä»¶
        local temp_mode="/dev/${mode##*/}"
        echo -E "`sed '/tunDevice/d' ${mode}`" > ${temp_mode}
        
        local clnc_dns="`get_configure clncå¯åŠ¨DNS`"
        # è®¾ç½®è§£ææ¨¡å¼çš„DNS ä¸è®¾ç½®è‡ªåŠ¨ä»ç³»ç»Ÿè·å–
        [[ ${clnc_dns} ]] && export CLNC_INIT_CONFIG_DNS="${clnc_dns}"
        
        # ä»¥GIDæ–¹å¼ å¯åŠ¨clncæ ¸å¿ƒ
        core_start_error_info="`${module_path}/clnc -g 3004 -c ${temp_mode} 2>&1`"
    else
        forward_uid="`echo "${mode_file_content}" | grep -E '(^ *user=)|(^ *uid=)' | sed -rn 's/[ ][ ]*//g;s/;//g;s/root/0/;s/inet/3003/;s/net_raw/3004/;s/.*=([0-9]+)/\1/;$p'`"
        forward_uid=${forward_uid:-"0"}
        
        # ä»¥UIDæ–¹å¼ å¯åŠ¨tinyæ ¸å¿ƒ
        core_start_error_info="`${module_path}/tiny -c ${mode} 2>&1`"
    fi
    
    # å¦‚æœæ ¸å¿ƒæ²¡å¼€å¯ï¼Œå°±é€€å‡ºå‡½æ•°
    [[ `pgrep ${unlimited_data_way}` ]] || return 2
    
    # æ‰“å¼€ipv4è·¯ç”±è½¬å‘
    echo '1' > /proc/sys/net/ipv4/ip_forward
    echo '1' > /proc/sys/net/ipv4/ip_dynaddr
    
    # åˆ¤æ–­æ˜¯å¦å…³é—­ SELinux
    [[ "å…³é—­" == `get_configure SELinux` ]] && setenforce 0
    
    # åˆ¤æ–­æ˜¯å¦å¯åŠ¨TCP_FASTOPEN
    [[ "clnc" == ${unlimited_data_way} && `echo "${mode_file_content}" | grep '^ *tcp_option *= *TFO'` ]] && echo '3' >/proc/sys/net/ipv4/tcp_fastopen
    
    # é€šè¿‡ipè·¯ç”±ç¦æ­¢æœ¬æœºipv6
    [[ "æ”¾è¡Œ" != ${ipv6_network} ]] && ip -6 rule add unreachable pref 100
    
    # æ‰§è¡Œæ ¸å¿ƒéƒ¨åˆ†çš„iptablesè§„åˆ™
    important_rules
    # æ‰§è¡Œæ¬¡è¦éƒ¨åˆ†çš„iptablesè§„åˆ™
    not_important_rules
    
    return 0
}


# é˜²è·³ä¸»ä½“éƒ¨åˆ† []<-(option...)
mainBody() {
    # åˆ¤æ–­å½“å‰è„šæœ¬æ‰§è¡ŒçŠ¶æ€
    if [[ `echo "${*}" | grep -E '(\-o)|(\-\-open)'` ]]; then
        script_execution_state="open"
        # ç¦æ­¢ç½‘ç»œ
        iptables -I OUTPUT ! -o wlan+ -j DROP
        iptables -I FORWARD -j DROP
    elif [[ `echo "${*}" | grep -E '(\-c)|(\-\-close)'` ]]; then
        script_execution_state="close"
    fi
    
    # åˆå§‹åŒ–
    init_zjl
    
    if [[ "open" == ${script_execution_state} ]]; then
        # æ‰“å¼€æ•°æ®
        network_on_off "open"
        # å…³é—­é˜²è·³
        close_zjl
        # æ‰“å¼€é˜²è·³
        open_zjl
        
        local start_code="${?}"
        # åˆ¤æ–­å¯åŠ¨çŠ¶æ€ç  æ­£å¸¸ä¸º0
        if [[ "0" != ${start_code} ]]; then
            # å…³é—­æ•°æ®
            svc data disable
            local log_path="${module_path}/start_error_log.txt"
            
            [[ ${unlimited_data_way} ]] && echo "å¼€å¯æ ¸å¿ƒ ${unlimited_data_way} å¤±è´¥" > ${log_path} || echo -n '' > ${log_path}
            echo 'é”™è¯¯åŸå› :' >> ${log_path}
            if [[ "1" == ${start_code} ]]; then
                case ${mode_file_state} in
                    no_selected_mode_file)
                        echo "æ²¡æ‰¾åˆ°æŒ‡å®šçš„ ${select_mode_file}.conf æ–‡ä»¶" >> ${log_path}
                    ;;
                    please_select)
                        echo "æœ‰å¤šä¸ªæ¨¡å¼æ–‡ä»¶ é˜²è·³ä¸çŸ¥é“å¯åŠ¨å“ªä¸€ä¸ª\næ‰€ä»¥è¯·ä½¿ç”¨ [é€‰æ‹©æ¨¡å¼] åŠŸèƒ½ !" >> ${log_path}
                        find "${mode_path}" -maxdepth 1 -type f -iname "*.conf" | while read ZJL; do
                            echo "    æ¨¡å¼: ${ZJL##*/}" >> ${log_path}
                        done
                    ;;
                    no_content)
                        echo "æ¨¡å¼å†…å®¹ä¸ºç©º !" >> ${log_path}
                    ;;
                    no_mode_file)
                        echo "æ²¡æ‰¾åˆ°æ¨¡å¼ æ‰€ä»¥è¯·æ·»åŠ æ¨¡å¼æ–‡ä»¶ !" >> ${log_path}
                    ;;
                esac
            else
                echo "${core_start_error_info}" >> ${log_path}
            fi
        fi
        
        # é‡Šæ”¾ç½‘ç»œ
        iptables -D OUTPUT ! -o wlan+ -j DROP
        iptables -D OUTPUT ! -o wlan+ -m owner ! --gid 3004 -j DROP
        iptables -D FORWARD -j DROP
        
    elif [[ "close" == ${script_execution_state} ]]; then
        # å…³é—­æ•°æ®
        network_on_off "close"
        # å…³é—­é˜²è·³
        close_zjl
    fi
    
    # åˆ¤æ–­æ˜¯å¦æ˜¾ç¤ºç•Œé¢
    [[ `echo "${*}" | grep -E '(\-d)|(\-\-display)'` ]] && show_display
}


# ä¸»å‡½æ•° []<-(option...)
main() {
    # åˆ¤æ–­é€‰é¡¹æ˜¯å¦åˆæ³•
    if [[ `echo "${*} " | grep -E "^((-[ocdihv][ ])|(--(open|kill|display|info|help|version)[ ])){1,3}$"` ]]; then
        # åˆ¤æ–­æ˜¯å¦å­˜åœ¨ -h æˆ– --help
        if [[ `echo "${*} " | grep -E '(\-h)|(\-\-help)'` ]]; then
            [[ "1" == ${#} ]] && show_help || show_help "-h æˆ–è€… --help åªèƒ½å•ç‹¬ä½¿ç”¨"
            
        # åˆ¤æ–­æ˜¯å¦å­˜åœ¨ -v æˆ– --version
        elif [[ `echo "${*} " | grep -E '(\-v)|(\-\-version)'` ]]; then
            [[ "1" == ${#} ]] && echo "ZJL é˜²è·³ ${zjl_version}" || show_help "-v æˆ–è€… --version åªèƒ½å•ç‹¬ä½¿ç”¨"            
        else
            # æ˜¾ç¤ºå¸®åŠ©
            [[ `echo "${*} " | grep -E '(\-o)|(\-\-open)' | grep -E '(\-c)|(\-\-close)'` ]] && show_help "ä¸å¯ä»¥åŒæ—¶æ‰§è¡Œå¼€å¯å’Œå…³é—­ï¼Œ-o å’Œ -c äºŒé€‰ä¸€"
        fi
    else
        # æ˜¾ç¤ºå¸®åŠ©
        show_help "å‚æ•°é”™è¯¯ï¼Œåªæ”¯æŒ1-3ä¸ªæœ‰æ•ˆå‚æ•°"
    fi  2>/dev/null
    
    # åˆ¤æ–­æ˜¯å¦æ˜¾ç¤ºé”™è¯¯è¾“å‡º
    [[ `echo "${*} " | grep -E '(\-i)|(\-\-info)'` ]] && mainBody ${*} || mainBody ${*} 2>/dev/null
}


# è°ƒç”¨ä¸»å‡½æ•°
main ${*}